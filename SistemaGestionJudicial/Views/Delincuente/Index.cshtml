@model IEnumerable<SistemaGestionJudicial.Models.Persona>

@{
    ViewData["Title"] = "Gestión de Delincuentes";
}

@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<script src="https://cdn.tailwindcss.com"></script>

<div class="flex h-screen overflow-hidden">
    <div class="flex-1 overflow-auto">
        <header class="bg-white shadow-sm py-4 px-6 flex justify-between items-center no-print">
            <h2 class="text-xl font-semibold text-gray-800" id="view-title">Dashboard</h2>
            <div class="flex items-center space-x-4">
                <div class="relative">
                    <input type="text" id="searchInput" onkeyup="filterTable()" placeholder="Buscar por cédula, nombre, género..."
                           class="pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                </div>
                <div class="flex items-center space-x-2 relative">
                    <button id="userMenuButton" class="flex items-center space-x-2 focus:outline-none">
                        <div class="h-8 w-8 rounded-full bg-blue-500 flex items-center justify-center text-white">
                            <i class="fas fa-user"></i>
                        </div>
                        <span class="text-sm font-medium">
                            @(HttpContextAccessor.HttpContext.Session.GetString("PrimerNombre") ?? "Usuario")
                        </span>
                        <i class="fas fa-chevron-down text-xs ml-1"></i>
                    </button>

                    <!-- Dropdown Menu -->
                    <div id="userDropdown" class="hidden absolute right-0 mt-2 w-40 bg-white border rounded shadow-lg z-20">
                        <a href="/Account/Logout" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                            <i class="fas fa-sign-out-alt mr-2"></i> Cerrar sesión
                        </a>
                    </div>
                </div>
            </div>
        </header>


        @* APLICAMOS ESTOS CAMBIOS AQUÍ para centrar y limitar el ancho *@
        <div class="p-6 max-w-6xl mx-auto">
            @* Aumentamos a max-w-6xl para la tabla *@
            @* --- Sección para mostrar mensajes de TempData --- *@
            @if (TempData["SuccessMessage"] != null)
            {
                <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-4" role="alert">
                    <i class="fas fa-check-circle mr-2"></i> @TempData["SuccessMessage"]
                    <span class="absolute top-0 bottom-0 right-0 px-4 py-3" onclick="this.parentElement.style.display='none';">
                        <i class="fas fa-times"></i>
                    </span>
                </div>
            }
            @if (TempData["ErrorMessage"] != null)
            {
                <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
                    <i class="fas fa-exclamation-triangle mr-2"></i> @TempData["ErrorMessage"]
                    <span class="absolute top-0 bottom-0 right-0 px-4 py-3" onclick="this.parentElement.style.display='none';">
                        <i class="fas fa-times"></i>
                    </span>
                </div>
            }
            @if (TempData["WarningMessage"] != null)
            {
                <div class="bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded relative mb-4" role="alert">
                    <i class="fas fa-exclamation-circle mr-2"></i> @TempData["WarningMessage"]
                    <span class="absolute top-0 bottom-0 right-0 px-4 py-3" onclick="this.parentElement.style.display='none';">
                        <i class="fas fa-times"></i>
                    </span>
                </div>
            }
            @* --- Fin de Sección de mensajes --- *@

            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Listado de Delincuentes</h2>
                <a asp-action="Create"
                   class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center">
                    <i class="fas fa-plus mr-2"></i> Añadir Delincuente
                </a>
            </div>

            <div class="card bg-white rounded-lg p-6">
                <div class="overflow-x-auto">
                    <table class="data-table min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cédula</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre Completo</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha Nacimiento</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Género</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="delincuentesTableBody" class="bg-white divide-y divide-gray-200">
                            @if (Model != null && Model.Any())
                            {
                                @foreach (var persona in Model)
                                {
                                    <tr id="row-@persona.IdPersona">
                                        <td class="px-6 py-4 whitespace-nowrap">@persona.IdPersona</td>
                                        <td class="px-6 py-4 whitespace-nowrap">@persona.Cedula</td>
                                        <td class="px-6 py-4 whitespace-nowrap">@($"{persona.Nombres} {persona.Apellidos}")</td>
                                        <td class="px-6 py-4 whitespace-nowrap">@(persona.FechaNacimiento?.ToString("yyyy-MM-dd") ?? "N/A")</td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            @{
                                                string generoDisplay = "N/A";
                                                if (persona.Genero == "M")
                                                {
                                                    generoDisplay = "Masculino";
                                                }
                                                else if (persona.Genero == "F")
                                                {
                                                    generoDisplay = "Femenino";
                                                }
                                                else if (persona.Genero == "O")
                                                {
                                                    generoDisplay = "Otro";
                                                }
                                            }
                                            @generoDisplay
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                                            <div class="flex items-center justify-center space-x-2">
                                                <a asp-action="Details" asp-route-id="@persona.IdPersona"
                                                   class="text-blue-600 hover:text-blue-900 focus:outline-none p-1 rounded-full hover:bg-blue-100" title="Ver Detalles">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                <a asp-action="Edit" asp-route-id="@persona.IdPersona"
                                                   class="text-yellow-600 hover:text-yellow-900 focus:outline-none p-1 rounded-full hover:bg-yellow-100" title="Editar">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                                <a asp-action="Delete" asp-route-id="@persona.IdPersona"
                                                   class="text-red-600 hover:text-red-900 focus:outline-none p-1 rounded-full hover:bg-red-100" title="Eliminar">
                                                    <i class="fas fa-trash-alt"></i>
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="6" class="px-6 py-4 whitespace-nowrap text-center text-gray-500">No se encontraron delincuentes.</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function filterTable() {
            var input, filter, table, tr, td, i, txtValue;
            input = document.getElementById("searchInput");
            filter = input.value.toUpperCase();
            table = document.querySelector(".data-table");
            tr = table.getElementsByTagName("tr");

            for (i = 0; i < tr.length; i++) {
                if (tr[i].getElementsByTagName("th").length > 0) {
                    continue;
                }

                var cedulaCol = tr[i].getElementsByTagName("td")[1];
                var nombreCol = tr[i].getElementsByTagName("td")[2];
                var generoCol = tr[i].getElementsByTagName("td")[4];

                if (cedulaCol || nombreCol || generoCol) {
                    var found = false;
                    if (cedulaCol) {
                        txtValue = cedulaCol.textContent || cedulaCol.innerText;
                        if (txtValue.toUpperCase().indexOf(filter) > -1) {
                            found = true;
                        }
                    }
                    if (!found && nombreCol) {
                        txtValue = nombreCol.textContent || nombreCol.innerText;
                        if (txtValue.toUpperCase().indexOf(filter) > -1) {
                            found = true;
                        }
                    }
                    if (!found && generoCol) {
                        txtValue = generoCol.textContent || generoCol.innerText;
                        if (txtValue.toUpperCase().indexOf(filter) > -1) {
                            found = true;
                        }
                    }

                    if (found) {
                        tr[i].style.display = "";
                    } else {
                        tr[i].style.display = "none";
                    }
                }
            }
        }
    </script>
    <script>
        const button = document.getElementById("userMenuButton");
        const dropdown = document.getElementById("userDropdown");

        document.addEventListener("click", (e) => {
            if (button.contains(e.target)) {
                dropdown.classList.toggle("hidden");
            } else {
                dropdown.classList.add("hidden");
            }
        });
    </script>
}