@model IEnumerable<SistemaGestionJudicial.Models.Persona>
@{
    ViewData["Title"] = "Gestión de Jueces";
}

@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>@ViewData["Title"]</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        .modal {
            z-index: 50;
        }

            .modal.hidden {
                display: none;
            }

        .data-table th, .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .data-table th {
            background-color: #1e40af;
            color: white;
            font-weight: 600;
        }

        .data-table tr:hover {
            background-color: #f8fafc;
        }

        .form-input {
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            width: 100%;
        }

        .scroll-btn {
            position: fixed;
            right: 30px;
            bottom: 30px;
            z-index: 100;
            display: none;
            background: #1e40af;
            color: white;
            padding: 12px 16px;
            border-radius: 9999px;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
    </style>
</head>

<body class="min-h-screen">

    @* MODAL DE ERROR (TempData) *@
    @if (TempData["ErrorMensaje"] != null)
    {
        <div id="error-modal" class="modal fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center z-50">
            <div class="modal-content bg-white rounded-lg p-6 w-96">
                <h3 class="text-lg font-bold mb-4 text-red-700">Error</h3>
                <p class="mb-4 text-gray-700">@TempData["ErrorMensaje"]</p>
                <div class="flex justify-end">
                    <button onclick="closeModal('error-modal')" class="bg-red-600 text-white px-4 py-2 rounded-lg">Cerrar</button>
                </div>
            </div>
        </div>
        <script>
            setTimeout(function () { closeModal('error-modal'); }, 5000);
        </script>
    }
    @if (!ViewData.ModelState.IsValid || ViewBag.OpenCreateModal == true)
    {
        <script>
            window.onload = function() {
                openModal('add-judge-modal');
            }
        </script>
    }

    @if (!ViewData.ModelState.IsValid)
    {
        <div class="bg-red-100 text-red-800 border border-red-400 rounded px-4 py-3 mb-4">
            <b>Errores:</b>
            <ul>
                @foreach (var e in ViewData.ModelState)
                {
                    foreach (var err in e.Value.Errors)
                    {
                        <li>@e.Key: @err.ErrorMessage</li>
                    }
                }
            </ul>
        </div>
    }

    <header class="bg-white shadow-sm py-4 px-6 flex justify-between items-center no-print">
        <h2 class="text-xl font-semibold text-gray-800">Gestión de Jueces</h2>

        <div class="relative flex items-center space-x-4">
            <button id="userMenuButton" class="flex items-center space-x-2 focus:outline-none">
                <div class="h-8 w-8 rounded-full bg-blue-500 flex items-center justify-center text-white">
                    <i class="fas fa-user"></i>
                </div>
                <span class="text-sm font-medium">
                    @(HttpContextAccessor.HttpContext.Session.GetString("PrimerNombre") ?? "Usuario")
                </span>
                <i class="fas fa-chevron-down text-xs ml-1"></i>
            </button>

            <!-- Dropdown Menu -->
            <div id="userDropdown" class="hidden absolute right-0 mt-2 w-40 bg-white border rounded shadow-lg z-20">
                <a href="/Account/Logout" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                    <i class="fas fa-sign-out-alt mr-2"></i> Cerrar sesión
                </a>
            </div>
        </div>
    </header>



    <div class="p-6">
        
        <div class="mb-6 flex flex-wrap justify-between items-center">
            <div>
                <label for="rowsPerPage" class="text-sm font-medium mr-2">Mostrar</label>
                <select id="rowsPerPage" class="form-input w-24 inline" onchange="changeRowsPerPage()">
                    <option value="5">5</option>
                    <option value="10" selected>10</option>
                    <option value="25">25</option>
                    <option value="all">Todos</option>
                </select>
                <span class="ml-2 text-sm">por página</span>
            </div>
            <button onclick="openModal('add-judge-modal')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center">
                <i class="fas fa-plus mr-2"></i> Añadir Juez
            </button>
        </div>
        <div class="card bg-white rounded-lg p-6">
            <div class="overflow-x-auto">
                <table class="data-table w-full" id="judgesTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nombre Completo</th>
                            <th>Cédula</th>
                            <th>Correo</th>
                            <th>Teléfono</th>
                            <th>Género</th>
                            <th>Dirección</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        @if (Model != null && Model.Any())
                        {
                            int row = 0;
                            foreach (var judge in Model)
                            {
                                <tr data-row="@row">
                                    <td>@judge.IdPersona</td>
                                    <td>@judge.Nombres @judge.Apellidos</td>
                                    <td>@judge.Cedula</td>
                                    <td>@judge.CorreoElectronico</td>
                                    <td>@judge.Telefono</td>
                                    <td>@judge.Genero</td>
                                    <td>@judge.Direccion</td>
                                    <td>
                                        <button type="button" class="text-green-600 hover:text-green-800 mr-2"
                                                onclick="openEditModal('@judge.IdPersona', '@judge.Cedula', '@judge.Nombres', '@judge.Apellidos', '@(judge.FechaNacimiento?.ToString("yyyy-MM-dd") ?? "")', '@judge.Genero', '@judge.Direccion', '@judge.Telefono', '@judge.CorreoElectronico')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button type="button" class="text-red-600 hover:text-red-800"
                                                onclick="openDeleteModal('@judge.IdPersona', '@judge.Nombres @judge.Apellidos')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                row++;
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="8" class="text-center text-gray-500 py-4">No existen jueces registrados.</td>
                            </tr>
                        }
                    </tbody>
                </table>
                <div class="flex justify-between items-center mt-4" id="paginationControls">
                    <button onclick="changePage(-1)" id="prevBtn" class="bg-gray-200 text-gray-700 px-3 py-1 rounded mr-2" disabled>Anterior</button>
                    <span id="pageInfo"></span>
                    <button onclick="changePage(1)" id="nextBtn" class="bg-gray-200 text-gray-700 px-3 py-1 rounded ml-2">Siguiente</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL CREAR JUEZ -->
    <div id="add-judge-modal" class="modal hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center">
        <div class="modal-content bg-white rounded-lg p-6 w-96">
            <h3 class="text-lg font-bold mb-4">Añadir Juez</h3>
            <form asp-action="CreateJuez" asp-controller="Jueces" method="post">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Cédula</label>
                    <input type="text" name="Cedula" class="form-input" maxlength="10" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Nombres</label>
                    <input type="text" name="Nombres" class="form-input" maxlength="100" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Apellidos</label>
                    <input type="text" name="Apellidos" class="form-input" maxlength="100" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Fecha de nacimiento</label>
                    <input type="date" name="FechaNacimiento" class="form-input">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Género</label>
                    <select name="Genero" class="form-input">
                        <option value="">Seleccionar</option>
                        <option value="M">Masculino</option>
                        <option value="F">Femenino</option>
                        <option value="O">Otro</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Dirección</label>
                    <input type="text" name="Direccion" class="form-input" maxlength="200">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Teléfono</label>
                    <input type="text" name="Telefono" class="form-input" maxlength="20">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Correo electrónico</label>
                    <input type="email" name="CorreoElectronico" class="form-input" maxlength="200">
                </div>
                <div class="flex justify-end">
                    <button type="button" onclick="closeModal('add-judge-modal')" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg mr-2">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg">Guardar</button>
                </div>
            </form>
        </div>
    </div>
    <!-- MODAL EDITAR JUEZ -->
    <div id="edit-judge-modal" class="modal hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center">
        <div class="modal-content bg-white rounded-lg p-6 w-96">
            <h3 class="text-lg font-bold mb-4">Editar Juez</h3>
            <form id="editJudgeForm" method="post">
                <input type="hidden" name="IdPersona" id="editIdPersona" />
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Cédula</label>
                    <input type="text" name="Cedula" id="editCedula" class="form-input" maxlength="10" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Nombres</label>
                    <input type="text" name="Nombres" id="editNombres" class="form-input" maxlength="100" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Apellidos</label>
                    <input type="text" name="Apellidos" id="editApellidos" class="form-input" maxlength="100" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Fecha de nacimiento</label>
                    <input type="date" name="FechaNacimiento" id="editFechaNacimiento" class="form-input">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Género</label>
                    <select name="Genero" id="editGenero" class="form-input">
                        <option value="">Seleccionar</option>
                        <option value="M">Masculino</option>
                        <option value="F">Femenino</option>
                        <option value="O">Otro</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Dirección</label>
                    <input type="text" name="Direccion" id="editDireccion" class="form-input" maxlength="200">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Teléfono</label>
                    <input type="text" name="Telefono" id="editTelefono" class="form-input" maxlength="20">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Correo electrónico</label>
                    <input type="email" name="CorreoElectronico" id="editCorreoElectronico" class="form-input" maxlength="200">
                </div>
                <div class="flex justify-end">
                    <button type="button" onclick="closeModal('edit-judge-modal')" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg mr-2">Cancelar</button>
                    <button type="button" onclick="submitEditForm()" class="bg-blue-600 text-white px-4 py-2 rounded-lg">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>
    <!-- MODAL ELIMINAR JUEZ -->
    <div id="delete-judge-modal" class="modal hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center">
        <div class="modal-content bg-white rounded-lg p-6 w-96">
            <h3 class="text-lg font-bold mb-4">Eliminar Juez</h3>
            <form id="deleteJudgeForm" method="post">
                <input type="hidden" name="IdPersona" id="deleteIdPersona" />
                <p class="mb-4">¿Estás seguro de que deseas eliminar al juez <span id="deleteJudgeName" class="font-bold"></span>?</p>
                <div class="flex justify-end">
                    <button type="button" onclick="closeModal('delete-judge-modal')" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg mr-2">Cancelar</button>
                    <button type="button" onclick="submitDeleteForm()" class="bg-red-600 text-white px-4 py-2 rounded-lg">Eliminar</button>
                </div>
            </form>
        </div>
    </div>

    <button id="scrollTopBtn" class="scroll-btn" onclick="scrollToTop()">
        <i class="fas fa-arrow-up"></i>
    </button>

    <script>
        // PAGINACIÓN
        let currentPage = 1;
        let rowsPerPage = 10;
        let judgesRows = [];
        let totalRows = 0;
        let tableBody = document.getElementById('tableBody');
        document.addEventListener("DOMContentLoaded", function () {
            judgesRows = Array.from(tableBody.querySelectorAll('tr[data-row]'));
            totalRows = judgesRows.length;
            paginate();
        });
        function paginate() {
            let value = document.getElementById('rowsPerPage').value;
            rowsPerPage = value === "all" ? totalRows : parseInt(value);
            let totalPages = Math.ceil(totalRows / rowsPerPage);
            if (currentPage > totalPages) currentPage = totalPages || 1;
            let start = (currentPage - 1) * rowsPerPage;
            let end = (value === "all") ? totalRows : start + rowsPerPage;
            judgesRows.forEach((row, i) => {
                row.style.display = (i >= start && i < end) ? "" : "none";
            });
            document.getElementById('pageInfo').innerText = `Página ${currentPage} de ${totalPages || 1}`;
            document.getElementById('prevBtn').disabled = currentPage <= 1;
            document.getElementById('nextBtn').disabled = currentPage >= totalPages || value === "all";
        }
        function changeRowsPerPage() { currentPage = 1; paginate(); }
        function changePage(dir) { currentPage += dir; paginate(); }

        // BOTÓN FLOTANTE PARA SCROLL TOP
        window.onscroll = function () {
            document.getElementById('scrollTopBtn').style.display =
                (window.scrollY > 200) ? 'block' : 'none';
        };
        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // MODALES CRUD
        function openModal(id) {
            document.getElementById(id).classList.remove('hidden');
        }
        function closeModal(id) {
            document.getElementById(id).classList.add('hidden');
        }
        function openEditModal(id, cedula, nombres, apellidos, fechaNacimiento, genero, direccion, telefono, correo) {
            document.getElementById('editIdPersona').value = id;
            document.getElementById('editCedula').value = cedula;
            document.getElementById('editNombres').value = nombres;
            document.getElementById('editApellidos').value = apellidos;
            document.getElementById('editFechaNacimiento').value = fechaNacimiento;
            document.getElementById('editGenero').value = genero;
            document.getElementById('editDireccion').value = direccion;
            document.getElementById('editTelefono').value = telefono;
            document.getElementById('editCorreoElectronico').value = correo;
            openModal('edit-judge-modal');
        }
        function openDeleteModal(id, nombre) {
            document.getElementById('deleteIdPersona').value = id;
            document.getElementById('deleteJudgeName').textContent = nombre;
            openModal('delete-judge-modal');
        }
        function submitEditForm() {
            var form = document.getElementById('editJudgeForm');
            form.action = '/Jueces/Edit/' + document.getElementById('editIdPersona').value;
            form.method = 'post';
            form.submit();
        }
        function submitDeleteForm() {
            var form = document.getElementById('deleteJudgeForm');
            form.action = '/Jueces/Delete/' + document.getElementById('deleteIdPersona').value;
            form.method = 'post';
            form.submit();
        }
    </script>
    <script>
        const button = document.getElementById("userMenuButton");
        const dropdown = document.getElementById("userDropdown");

        document.addEventListener("click", (e) => {
            if (button.contains(e.target)) {
                dropdown.classList.toggle("hidden");
            } else {
                dropdown.classList.add("hidden");
            }
        });
    </script>
</body>
</html>
